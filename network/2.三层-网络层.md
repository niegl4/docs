[TOC]

# IP

## 报文格式

<img src="https://github.com/NieGuanglin/docs/blob/main/pics/network/ip/1ip-ip%E6%8A%A5%E6%96%87%E6%A0%BC%E5%BC%8F.png">

<img src="/Users/nieguanglin/docs/pics/network/ip/1ip-ip报文格式.png" alt="1ip-ip报文格式.png" style="zoom:100%;" />

报文字段：

- 版本号：主流版本是IPv4。
- 服务类型TOS：Type Of Service，服务类型。共四位，每一位0表示正常，1表示特殊的含义：
  - 0001：最小代价
  - 0010：最大可靠性
  - 0100：最大吞吐量
  - 1000：最小延迟
- **TTL**：每经过一个路由器，数值减一。等于零时，包被丢弃。
- 协议：下一层是TCP，还是UDP。

## 网关

<img src="https://github.com/NieGuanglin/docs/blob/main/pics/network/ip/1-1ip-%E8%B7%AF%E7%94%B1%E5%99%A8-%E7%BD%91%E5%85%B3-%E4%BA%A4%E6%8D%A2%E6%9C%BA%E7%A4%BA%E6%84%8F.png">

<img src="/Users/nieguanglin/docs/pics/network/ip/1-1ip-路由器-网关-交换机示意.png" alt="1-1ip-路由器-网关-交换机示意.png" style="zoom:100%;" />

网关往往是一个路由器，是一个三层转发的设备。

准确的说，路由器的每一个网口都连接了一个局域网，同一个局域网拥有相同的网段，不同的局域网拥有不同的网段。网口就是它所在局域网的网关。

网关地址一定和源IP地址是同一个网段的，往往不是第一个主机号，就是第二个主机号。

## 路由

路由的规则为：

**要访问某个网段，从某个网口出去，下一跳的地址是某某。**

**要访问某个网段，从某个网口出去，没有下一跳（本路由器就是最后一跳）。**

```bash
$ ip route
# 目标网段；下一跳地址；出口设备
default	via	9.134.0.1	dev	eth1

9.134.0.0/20	dev	eth1	proto	kernel	scope	link	src	9.134.12.251
172.17.0.0/16	dev	docker0	proto	kernel	scope	link	src	172.17.0.1

169.254.0.0/16	dev	eth1	scope	link	metric	1002

$ route
Destination	Gateway		Genmask			Flags	Metric	Ref	Use	Iface
default		9.134.0.1	0.0.0.0			UG		0		0	0	eth1

# 路由规则的网关是0.0.0.0，意味着这是一条直连规则。
# 即，凡是匹配到这条规则的ip包，应该经过本机的网卡，通过二层网络直接发往目的主机。
9.134.0.0	0.0.0.0		255.255.240.0	U		0		0	0	eth1
172.17.0.0	0.0.0.0		255.255.0.0		U		0		0	0	docker0

link-local	0.0.0.0		255.255.0.0		U		1002	0	0	eth1
```



MAC地址是一个局域网内有效的地址。MAC地址只要过网关，就必定会改变，因为已经换了局域网。

- 静态路由

  - 转发网关

    局域网与局域网之间IP不冲突，不改变IP地址。

  - NAT网关

    局域网与局域网之间IP冲突，需要改变IP地址。NAT，Network Address Translation，改变源IP地址，即为SNAT；改变目标IP地址，即为DNAT。

- 动态路由

  根据路由协议算法生成动态路由表，随网络运行状况的变化而变化。

  - OSPF，IGP

    **OSPF**，Open Shortest Path First，开放式最短路径优先。是一个基于链路状态路由算法的协议，广泛应用在数据中心中的协议。

    由于主要用在数据中心内部，用于路由决策，因而称为内部网关协议，Interior Gateway Protocol，**IGP**。

    应用的接入层会有负载均衡LVS，它可以和OSPF一起，实现高吞吐量的接入层设计。

  - BGP
  
    外网的路由协议，称为外网路由协议，Border Gateway Protocol，**BGP**。
    
    基于路径矢量路由协议，是距离矢量路由协议的升级版。
    
    BGP分两类，eBGP，自治系统间，边界路由之间使用eBGP广播路由；iBGP，边界路由器通过iBGP，将学习到的路由导入到内部网络，使得内部的路由器能够找到到达外网目的地的最好的边界路由器。

##  ip addr

<img src="https://github.com/NieGuanglin/docs/blob/main/pics/network/ip/2Linux-ip-addr.png">

<img src="/Users/nieguanglin/docs/pics/network/ip/2Linux-ip-addr.png" alt="2Linux-ip-addr.png" style="zoom:100%;" />

- 无类型域间选路，CIDR

  **CIDR**：打破了原来设计的几类地址的做法，**将32位的IP地址一分为二，前面是网络号，后面是主机号**。192.168.37.3/24，32位中前24位是网络号，后8位是主机号。

  **广播地址**：192.168.37.255，将数据包发送给广播地址，则192.168.37网段内的机器都可以收到。

  **子网掩码**：255.255.255.0，将子网掩码与IP地址按位与，可以得到网络号。

  （私有网络的出口地址，往往就是该网络中的第一个主机号，例如：192.168.37.1。）

  （组播地址：五类地址中的D类，使用这类地址，属于某个组的机器都能收到。）

- lo，即lookback，环回接口，往往会被分配到127.0.0.1。这个地址用于本机通信，经过内核处理后直接返回，不会在任何网络中出现。

- scope host与scope global，对于lo，是host，说明这张网卡仅仅可以供本机相互通信。对于ens33，是global，说明这张网卡是可以对外的，可以接收来自各个地方的包。

- MAC地址，link/ether后面的就是MAC地址，是一个网卡的物理地址，用十六进制表示，6个byte。MAC地址全局唯一，但仅仅在局域网内具有定位功能。在同一子网内，可以使用MAC通信；跨子网，就需要IP地址。

- net_device flags，网络设备的状态标识。

  - BROADCAST：该网卡有广播地址，可以发送广播包
  - MULTICAST：该网卡可以发送多播包
  - UP：该网卡处于启动状态
  - LOWER_UP：L1是启动的。表示物理网络是联通的，即网卡已经连接到了交换机或路由器中。如果没有，通常表示网线被拔掉了。

- **mtu**，最大传输单元为1500bytes。mtu是二层MAC的概念，以太网规定一个帧不允许超过1500字节，如果放不下，就需要分片传输。

- qdisc pfifo_fast。

  - qdisc，queueing discipline，排队规则。内核如果需要通过某个网络接口**发送**数据包，都需要为这个接口配置qdisc，把数据包加入队列。

  - pfifo_fast，是一种不对网络包分类的技术。

    pfifo_fast分为三个先入先出的队列，称为三个Band。根据ip头里的TOS，决定包进入哪个队列。

    使用命令行tc qdisc show dev <网卡名>，可以输出TOS与Band的映射。

    Band0优先级最高，发送完毕才轮到Band1，最后才是Band2。

    这些内容与网络控制有关，即QoS，Quality of Service。
    
  - pfifo，最简单的排队规则，不对进入的网络包做任何处理，数据包采用先入先出的方式通过队列。



# ICMP

Internet Control Message Protocol，互联网控制报文协议。

## 报文格式

ICMP报文封装在IP包里面。

<img src="https://github.com/NieGuanglin/docs/blob/main/pics/network/ip/3ip-icmp%E6%8A%A5%E6%96%87%E6%A0%BC%E5%BC%8F.png">

<img src="/Users/nieguanglin/docs/pics/network/ip/3ip-icmp报文格式.png" alt="3ip-icmp报文格式.png" style="zoom:100%;" />

## 报文类型

### 查询报文类型

报文的类型字段：

- 8：主动请求。
- 0：主动应答。

报文的序号字段：

- 用于区分连续ping的时候发出的多个数据包。

应用举例：

- ping构建ICMP请求数据包，类型为8；顺序号来区分连续发送的多个数据包。报文的数据部分插入发送时间，用来计算往返时间RTT。IP层将ICMP数据包封装为IP数据包，MAC层将IP数据包封装为MAC数据帧，发送出去。

  然后目标主机构建ICMP应答数据包，类型为0；顺序号为接收到的请求数据包中的顺序号。再层层封装发给源主机。

### 差错报文类型

报文的类型字段：

- 3：终点不可达。

  原因：

  - 0：网络不可达。
  - 1：主机不可达。
  - 2：协议不可达。
  - 3：端口不可达。
  - 4：需要分片但设置了不分片标志位。

- 4：源抑制，让源站放慢发送速度。

- 11：超时，超过网络包的生存时间还是没到。

- 5：重定向，让下次发给另一个路由器。

应用举例：

- traceroute故意设置特殊的TTL，来追踪去往目的地时沿途经过的路由器。

  它在逐个发送UDP数据报的时候，递增TTL。根据路由器回复的ICMP差错报文，逐个获取所有路由器的IP。并且，它的UDP目标端口往往是不可能的值，这样当数据报最终到达目的地时，目的主机的UDP模块回复一份“端口不可达”的ICMP差错报文，从而知道到达目的主机。

- traceroute故意设置不分片，来确定路径的MTU。

  设置“不分片”的标志。发送的第一个分组的长度正好与出口MTU相等。如果中间遇到窄的关口会被卡住，对方就会发送ICMP差错报文，类型为“需要分片但设置了不分片标志位”。然后每次收到ICMP这个报文就减小分组的长度，直到到达目标主机。



# iptables

## Netfilter

- 网络包的处理流程

  <img src="https://github.com/NieGuanglin/docs/blob/main/pics/network/ip/4ip-Netfilter%E4%BA%94%E4%B8%AA%E8%8A%82%E7%82%B9.png">

  <img src="/pics/network/ip/4ip-Netfilter五个节点.png" alt="4ip-Netfilter五个节点.png" style="zoom:100%;" />

  1. 首先拆开Mac头，看是不是本网卡的。如果是，拆开IP头。得到目标IP后，开始路由判断。在路由判断之前，这个节点叫**PREROUTING**。
  2. 如果IP是我的，包就发给传输层，这个节点叫**INPUT**。
  3. 如果IP不是我的，包就转发出去，这个节点叫**FORWARD**。
  4. 上层处理完毕后，一般会返回一个处理结果。这个结果会发出去，这个节点叫**OUTPUT**。无论FORWARD还是OUTPUT，都是路由判断之后发生的。
  5. 最终发出去之前，这个节点叫**POSTROUTING**。

- Netfilter框架

  Netfilter框架可以在这些节点插入hook函数。这些函数可以截获数据包，对数据包进行干预。例如做一定的修改，然后决策是否接着交给TCP/IP协议栈处理。

  - **ACCEPT**：数据包被转发。
  - **DROP**：数据包被丢弃。
  - **QUEUE**：发送给某个用户态进程处理。这个经常用在内部负载均衡，目标地址的个数和权重都可以变。
  - **RETURN**: 处理将在之前出发的一条链中继续，形成了一种包过滤链子调用。

## iptables

- 内核模块ip_tables

  它在这五个节点埋下函数，从而可以根据规则进行包的处理。按功能可以分为四大类：

  - 连接跟踪，conntrack。比如，私网IP请求公网IP时，在出公网网口时，需要SNAT为公网IP。当响应返回DNAT时，就会在conntrack表里面查询连接的记录。找到正确的私网IP后，再做DNAT。
  - 数据包过滤，filter。
  - 网络地址转换，nat。
  - 数据包修改，mangle。

  连接跟踪是基础功能，被其他功能所依赖。其他三个可以实现包的过滤，网络地址转换和包的修改。

- 命令行iptables

  <img src="https://github.com/niegl4/docs/blob/main/pics/network/ip/5ip-iptables%E7%9A%84%E8%A1%A8%E4%B8%8E%E9%93%BE.png">

  <img src="/pics/network/ip/5ip-iptables的表与链.png" alt="5ip-iptables的表与链.png" style="zoom:100%;" />

  按**功能**划分，iptables的**表**分为四种：raw，mangle，nat，filter。优先级依次降低，raw不常用，所以主要功能都在其他三种表里实现。每个表可以在多个节点干预数据包，也即每个表可以设置在多个链。filter表中主要实现安全策略。nat表中主要实现虚拟网络和物理网络地址的转换。

  按**处理时机**划分，划分为五个**链**：
  
  - **filter表**：
    1. INPUT链：过滤所有目标地址是本机的数据包。
    2. FORWARD链：过滤所有路过本机的数据包。
    3. OUTPUT链：过滤所有由本机产生的数据包。
  - **nat表**：
    1. PREROUTING链：DNAT。
    2. OUTPUT链：DNAT。
    3. POSTROUTING链：SNAT。
  - mangle表：
    1. PREROUTING链。
    2. INPUT链。
    3. FORWARD链。
    4. OUTPUT链。
    5. POSTROUTING链。

